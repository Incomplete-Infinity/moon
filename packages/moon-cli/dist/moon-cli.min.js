#!/usr/bin/env node
/**
 * Moon CLI v1.0.0-beta.4
 * Copyright 2016-2019 Kabir Shah
 * Released under the MIT License
 * https://kbrsh.github.io/moon
 */
!function(){"use strict";var e=require("fs"),n=require("path"),t=require("https"),o=require("child_process").exec,a=/<\w+>/g,r=/(?:^|\s)(?:\[\w+\]|--?\w+)/g,i={version:{usage:"moon version",description:"output Moon CLI version"},help:{usage:"moon help <command>",description:"output help message for command",parameters:{"<command>":"name of Moon CLI command"}},create:{usage:"moon create <name> [options]",description:"create application in new directory",parameters:{"<name>":"name of application and directory"},options:{"-t, --template <username>/<repository>":"GitHub repository to use as template"}}};function c(e,n){console.log("\x1b[34m"+e+"\x1b[0m "+n)}function s(e){console.log(e.replace(a,"\x1b[33m$&\x1b[0m").replace(r,"\x1b[36m$&\x1b[0m"))}function d(e){console.log("\x1b[31merror\x1b[0m "+e)}function l(e){var n=Object.keys(e),t=Math.max.apply(null,n.map((function(e){return e.length})));return n.map((function(n){return"\t"+n+" ".repeat(t-n.length+3)+e[n]})).join("\n")}function m(e,n,t){var o=e.indexOf(n);if(-1===o)return e;var a=e.slice(0,o),r=m(e.slice(o+n.length),n,t),i=Buffer.from(t);return Buffer.concat([a,i,r],a.length+i.length+r.length)}for(var p=2===process.argv.length?["help"]:process.argv.slice(2),u=p[0],v=[],h={},f=1;f<p.length;f++){var g=p[f];if("-"===g[0])for(;f<p.length;f++){var T=p[f];"-"===T[0]?h[T]=!0:h[p[f-1]]=T}else v.push(g)}switch(u){case"version":s("Moon CLI v1.0.0-beta.4");break;case"help":var x=v[0];if(x in i){var w=i[x];s("Usage: "+w.usage+"\n\t"+w.description),"parameters"in w&&s("\nParameters:\n"+l(w.parameters)),"options"in w&&s("\nOptions:\n"+l(w.options))}else{var k={};for(var y in i){var R=i[y];k[R.usage]=R.description}s("Usage: moon <command> [options]\n\nCommands:\n"+l(k))}break;case"create":var A=v[0],E=h["-t"]||h["--template"]||"kbrsh/moon-template";void 0!==A&&0!==A.length||d("Invalid or unknown name.\n\nAttempted to create an application.\n\nReceived an invalid or unknown name.\n\nExpected a valid name. Run \x1b[35mmoon help create\x1b[0m to see usage information."),!0===E&&d("Invalid or unknown template.\n\nAttempted to create an application.\n\nReceived an invalid or unknown template.\n\nExpected a valid template. Run \x1b[35mmoon help create\x1b[0m to see usage information."),c("Moon","creating application"),function(a,r){var i={method:"GET",host:"api.github.com",path:"/repos/"+r+"/tarball/master",headers:{"User-Agent":"Moon"}};t.get(i,(function(s){var l=s.statusCode;l>=300&&l<400?t.get(s.headers.location,(function(t){var i=t.statusCode;if(i>=200&&i<300){var s=n.join(__dirname,"moon-template.tar.gz"),l=e.createWriteStream(s);t.on("data",(function(e){l.write(e)})),t.on("end",(function(){l.end(),c("downloaded",r),function(t,a){var r=n.join(process.cwd(),t);o("mkdir "+r,(function(i){null!==i&&d("Failed directory creation.\n\nAttempted to create directory:\n\t"+r+"\n\nReceived error:\n\t"+i+"\n\nExpected successful directory creation."),o("tar -xzf "+a+" -C "+r+" --strip=1",(function(o){null!==o&&d("Failed archive extraction.\n\nAttempted to extract archive to target:\n\t"+a+" -> "+r+"\n\nReceived error:\n\t"+o+"\n\nExpected successful archive extraction."),c("installed",r),function(t,o,a){e.unlink(o,(function(r){null!==r&&d("Failed archive deletion.\n\nAttempted to delete archive:\n\t"+o+"\n\nReceived error:\n\t"+r+"\n\nExpected successful archive deletion."),c("cleaned",o),function t(o,a,r){for(var i=e.readdirSync(a),s=0;s<i.length;s++){var d=i[s],l=n.join(a,d);e.statSync(l).isDirectory()?t(o,l,r):(e.writeFileSync(l,m(e.readFileSync(l),"{# MoonName #}",o)),c("processed",n.relative(r,l)))}}(t,a,a),c("created","application \x1b[36m"+t+"\x1b[0m\n\nTo start, run:\n\tcd "+t+"\n\tnpm install\n\tnpm run dev")}))}(t,a,r)}))}))}(a,s)}))}else d("Invalid download HTTP response.\n\nAttempted to download template:\n\t"+t.headers.location+"\n\nReceived error HTTP status code:\n\t"+i+"\n\nExpected success HTTP status code (200-299).")})).on("error",(function(e){d("Failed download HTTP request.\n\nAttempted to download template:\n\t"+s.headers.location+"\n\nReceived error:\n\t"+e+"\n\nExpected successful HTTP request.")})):d("Invalid archive link HTTP response.\n\nAttempted to fetch archive link for template:\n\thttps://"+i.host+i.path+"\n\nReceived error HTTP status code:\n\t"+l+"\n\nExpected redirect HTTP status code (300-399).")})).on("error",(function(e){d("Failed archive link HTTP request.\n\nAttempted to fetch archive link for template:\n\thttps://"+i.host+i.path+"\n\nReceived error:\n\t"+e+"\n\nExpected successful HTTP request.")}))}(A,E);break;default:d("Unrecognized command.\n\nAttempted to execute a command.\n\nReceived a command that does not exist:\n\t"+u+"\n\nExpected a valid command. Run \x1b[35mmoon help\x1b[0m to see valid commands.")}}();